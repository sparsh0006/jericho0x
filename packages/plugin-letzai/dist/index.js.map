{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import { elizaLogger, HandlerCallback, IAgentRuntime, Plugin, State } from \"@elizaos/core\";\r\nimport { Memory } from \"@elizaos/core\";\r\n\r\n\r\n/*\r\nconst improvePrompt = false;\r\n\r\n//None of this really works with the default generateText() function, so I'm leaving it out for now.\r\nlet IMAGE_SYSTEM_PROMPT;\r\n\r\nif(improvePrompt){\r\n    IMAGE_SYSTEM_PROMPT = `You are an expert in writing prompts for AI art generation for T5 based models. You excel at creating detailed and creative visual descriptions. Incorporating specific elements naturally. Always aim for clear, descriptive language that generates a creative picture. Your output should only contain the description of the image contents, but NOT an instruction like \"create an image that...`;\r\n}\r\nelse\r\n{\r\n    IMAGE_SYSTEM_PROMPT = `You are an expert in writing Text-to-Image prompts. Your task is to analyze a user's instruction and extract only his demand for an image. You should be able to understand the user's request and generate a prompt that is clear and concise. Your output should only contain the description of the image contents, but NOT an instruction like \"create an image that... You never REMOVE any information from the user's request, except for his instructions like \"Make an image of...\". You DO NEVER REMOVE any tags like for example @hailee or @modelname and you DO NOT REMOVE intensities like :0.3, as in @hailee:0.3. You DO NEVER REMOVE any information that is not an instruction.`;\r\n}\r\n*/\r\n\r\nasync function pollLetzAiImageStatus(\r\n    id: string,\r\n    letzAiApiKey: string,\r\n    callback: any,\r\n    maxPolls = 40,\r\n    pollIntervalMs = 3000 // 3 seconds\r\n) {\r\n    let polls = 0;\r\n    let isReady = false;\r\n\r\n    while (!isReady && polls < maxPolls) {\r\n        // Wait 3 seconds before checking\r\n        await new Promise((resolve) => setTimeout(resolve, pollIntervalMs));\r\n        polls++;\r\n\r\n       callback({\r\n            text: `Still working on your image... (Poll #${polls})`,\r\n        });\r\n\r\n        try {\r\n            const resp = await fetch(`https://api.letz.ai/images/${id}`, {\r\n                method: \"GET\",\r\n                headers: {\r\n                    Authorization: `Bearer ${letzAiApiKey}`,\r\n                },\r\n            });\r\n            if (!resp.ok) {\r\n                callback({\r\n                    text: `Error checking LetzAI status: ${resp.status} - ${resp.statusText}`,\r\n                });\r\n                return;\r\n            }\r\n\r\n            const statusData = await resp.json();\r\n            const { status, imageVersions } = statusData;\r\n\r\n            if (status === \"ready\") {\r\n                isReady = true;\r\n                // The final image URL might be in imageVersions[\"original\"]\r\n                let finalUrl = imageVersions?.original;\r\n                if (Array.isArray(finalUrl) && finalUrl.length > 0) {\r\n                    finalUrl = finalUrl[0];\r\n                }\r\n\r\n                if (!finalUrl) {\r\n                    callback({\r\n                        text: `Image is ready, but no final URL found.`,\r\n                    });\r\n                    return;\r\n                }\r\n\r\n                callback({\r\n                    text: `Your image is ready!`,\r\n                    attachments: [\r\n                        {\r\n                            id,\r\n                            url: finalUrl,\r\n                            title: \"LetzAI Full Image\",\r\n                            source: \"letzAiImageGeneration\",\r\n                            description: \"Full-size image from LetzAI\",\r\n                            contentType: \"image/jpeg\",\r\n                            text: \"Here's your final image (original).\",\r\n                        },\r\n                    ],\r\n                });\r\n            }\r\n        } catch (err: any) {\r\n            callback({\r\n                text: `Error while polling LetzAI: ${err.message}`,\r\n            });\r\n            return;\r\n        }\r\n    }\r\n\r\n    if (!isReady) {\r\n        callback({\r\n            text: `The image is still not ready after ${maxPolls} polls. Please try again later.`,\r\n        });\r\n    }\r\n}\r\n\r\nexport const letzAiImageGeneration = {\r\n    name: \"GENERATE_IMAGE\",\r\n    similes: [\"IMAGE_GENERATION\", \"IMAGE_GEN\"],\r\n    description: \"Generate an image via LetzAI API (with polling).\",\r\n    suppressInitialMessage: true,\r\n\r\n    validate: async (_runtime: any, _message: any, _state: any) => {\r\n        // Provide a default validate() that simply returns true\r\n        return true;\r\n    },\r\n\r\n    handler: async (\r\n        runtime: IAgentRuntime,\r\n        message: Memory,\r\n        _state: State,\r\n        options: {\r\n            width?: number;\r\n            height?: number;\r\n            quality?: number;\r\n            creativity?: number;\r\n            seed?: number;\r\n            modelId?: string;\r\n            jobId?: string;\r\n            hasWatermark?: boolean;\r\n            mode?: \"default\" | \"sigma\";\r\n            systemVersion?: number;\r\n        },\r\n        callback: HandlerCallback\r\n    ) => {\r\n        try {\r\n            // 1) Get the LLM's response\r\n            elizaLogger.log(\"Composing state for message:\", message.content.text);\r\n\r\n            // Removed logging of non-existent property recentMessagesData\r\n            callback({\r\n                text: message.content.text,\r\n\r\n            });\r\n\r\n            // 2) Next, send the prompt to LetzAI\r\n            const userPrompt = message?.content?.text || \"No prompt provided.\";\r\n            const letzAiApiKey = runtime.getSetting(\"LETZAI_API_KEY\") || \"fake_api_key\";\r\n            const letzAiModels = runtime.getSetting(\"LETZAI_MODELS\") || \"\";\r\n\r\n            const width = options.width ?? 720;\r\n            const height = options.height ?? 1280;\r\n            const quality = options.quality ?? 2;\r\n            const creativity = options.creativity ?? 1;\r\n            const hasWatermark = options.hasWatermark ?? true;\r\n            const systemVersion = options.systemVersion ?? 3;\r\n            const mode = options.mode?? \"default\";\r\n\r\n            //use this if you want to improve your prompts some more before submitting them\r\n            //we're not using it rn, because the generateText() function doesn't seem to work properly and returns bad prompts\r\n            /*\r\n            const CONTENT = `${userPrompt}`.trim();\r\n\r\n            const IMAGE_PROMPT_INPUT = `${CONTENT}`;\r\n\r\n            let imagePrompt = await generateText({\r\n                runtime,\r\n                context: IMAGE_PROMPT_INPUT,\r\n                modelClass: ModelClass.LARGE,\r\n                customSystemPrompt: IMAGE_SYSTEM_PROMPT,\r\n            });*/\r\n\r\n            let imagePrompt = `${userPrompt}`.trim();\r\n\r\n            //Prepend our Models from the .env config to make sure characters, styles and objects are respected\r\n            imagePrompt = letzAiModels + \", \" + imagePrompt;\r\n            const prompt = imagePrompt;\r\n\r\n            elizaLogger.log(\"Image prompt received:\", imagePrompt);\r\n\r\n            const createResp = await fetch(\"https://api.letz.ai/images\", {\r\n                method: \"POST\",\r\n                headers: {\r\n                    \"Content-Type\": \"application/json\",\r\n                    Authorization: `Bearer ${letzAiApiKey}`,\r\n                },\r\n                body: JSON.stringify({\r\n                    prompt,\r\n                    width,\r\n                    height,\r\n                    quality,\r\n                    creativity,\r\n                    hasWatermark,\r\n                    systemVersion,\r\n                    mode\r\n                }),\r\n            });\r\n\r\n\r\n            const createData = await createResp.json();\r\n            if (!createResp.ok) {\r\n                callback({\r\n                    text: `LetzAI creation failed: ${createData?.message || \"Unknown error\"}`,\r\n                });\r\n                return;\r\n            }\r\n\r\n\r\n\r\n            // 3) Let the user know weâ€™ve started generating\r\n            const { id, status, progress } = createData;\r\n            callback({\r\n                text: `Started generating your image. (ID: ${id}, status: ${status}, progress: ${progress}%)`,\r\n            });\r\n\r\n            // 4) Begin polling every 5s\r\n            await pollLetzAiImageStatus(id, letzAiApiKey, callback, /* maxPolls */ 20, /* pollIntervalMs */ 5000);\r\n        } catch (error: any) {\r\n            callback({\r\n                text: `Error while requesting LetzAI: ${error.message}`,\r\n            });\r\n        }\r\n    },\r\n\r\n    examples: [\r\n        [\r\n            {\r\n                user: \"{{user1}}\",\r\n                content: {\r\n                    text: \"Generate an image of a neon futuristic cityscape\",\r\n                },\r\n            },\r\n            {\r\n                user: \"{{agentName}}\",\r\n                content: {\r\n                    text: \"Sure, generating image via LetzAI...\",\r\n                    action: \"GENERATE_IMAGE\",\r\n                },\r\n            },\r\n            {\r\n                user: \"{{user1}}\",\r\n                content: { text: \"Take a selfie\" },\r\n            },\r\n            {\r\n                user: \"{{agentName}}\",\r\n                content: {\r\n                    text: \"Alright, hold on while I generate that selfie...\",\r\n                    action: \"GENERATE_IMAGE\",\r\n                },\r\n            },\r\n            {\r\n                user: \"{{user1}}\",\r\n                content: { text: \"Make an image of a man on the beach\" },\r\n            },\r\n            {\r\n                user: \"{{agentName}}\",\r\n                content: {\r\n                    text: \"Making an image of a man on the beach!\",\r\n                    action: \"GENERATE_IMAGE\",\r\n                },\r\n            },\r\n        ],\r\n\r\n    ],\r\n};\r\n\r\nexport const letzAIPlugin:Plugin = {\r\n    name: \"letzai\",\r\n    description: \"LetzAI Image Generation Plugin\",\r\n    actions: [letzAiImageGeneration],\r\n    evaluators: [],\r\n    providers: [],\r\n};\r\n\r\nexport default letzAIPlugin;\r\n"],"mappings":"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","names":[]}