{"version":3,"sources":["../src/index.ts","../src/constants.ts"],"sourcesContent":["import { elizaLogger } from \"@elizaos/core\";\r\nimport {\r\n    Action,\r\n    HandlerCallback,\r\n    IAgentRuntime,\r\n    Memory,\r\n    Plugin,\r\n    State,\r\n} from \"@elizaos/core\";\r\nimport fs from \"fs\";\r\nimport { LUMA_CONSTANTS } from \"./constants\";\r\n\r\nconst generateVideo = async (prompt: string, runtime: IAgentRuntime) => {\r\n    const API_KEY = runtime.getSetting(LUMA_CONSTANTS.API_KEY_SETTING);\r\n\r\n    try {\r\n        elizaLogger.log(\"Starting video generation with prompt:\", prompt);\r\n\r\n        const response = await fetch(LUMA_CONSTANTS.API_URL, {\r\n            method: \"POST\",\r\n            headers: {\r\n                Authorization: `Bearer ${API_KEY}`,\r\n                accept: \"application/json\",\r\n                \"Content-Type\": \"application/json\",\r\n            },\r\n            body: JSON.stringify({ prompt }),\r\n        });\r\n\r\n        if (!response.ok) {\r\n            const errorText = await response.text();\r\n            elizaLogger.error(\"Luma API error:\", {\r\n                status: response.status,\r\n                statusText: response.statusText,\r\n                error: errorText,\r\n            });\r\n            throw new Error(\r\n                `Luma API error: ${response.statusText} - ${errorText}`\r\n            );\r\n        }\r\n\r\n        const data = await response.json();\r\n        elizaLogger.log(\r\n            \"Generation request successful, received response:\",\r\n            data\r\n        );\r\n\r\n        // Poll for completion\r\n        let status = data.status;\r\n        let videoUrl = null;\r\n        const generationId = data.id;\r\n\r\n        while (status !== \"completed\" && status !== \"failed\") {\r\n            await new Promise((resolve) => setTimeout(resolve, 5000)); // Wait 5 seconds\r\n\r\n            const statusResponse = await fetch(\r\n                `${LUMA_CONSTANTS.API_URL}/${generationId}`,\r\n                {\r\n                    method: \"GET\",\r\n                    headers: {\r\n                        Authorization: `Bearer ${API_KEY}`,\r\n                        accept: \"application/json\",\r\n                    },\r\n                }\r\n            );\r\n\r\n            if (!statusResponse.ok) {\r\n                const errorText = await statusResponse.text();\r\n                elizaLogger.error(\"Status check error:\", {\r\n                    status: statusResponse.status,\r\n                    statusText: statusResponse.statusText,\r\n                    error: errorText,\r\n                });\r\n                throw new Error(\r\n                    \"Failed to check generation status: \" + errorText\r\n                );\r\n            }\r\n\r\n            const statusData = await statusResponse.json();\r\n            elizaLogger.log(\"Status check response:\", statusData);\r\n\r\n            status = statusData.state;\r\n            if (status === \"completed\") {\r\n                videoUrl = statusData.assets?.video;\r\n            }\r\n        }\r\n\r\n        if (status === \"failed\") {\r\n            throw new Error(\"Video generation failed\");\r\n        }\r\n\r\n        if (!videoUrl) {\r\n            throw new Error(\"No video URL in completed response\");\r\n        }\r\n\r\n        return {\r\n            success: true,\r\n            data: videoUrl,\r\n        };\r\n    } catch (error) {\r\n        elizaLogger.error(\"Video generation error:\", error);\r\n        return {\r\n            success: false,\r\n            error: error.message || \"Unknown error occurred\",\r\n        };\r\n    }\r\n};\r\n\r\nconst videoGeneration: Action = {\r\n    name: \"GENERATE_VIDEO\",\r\n    similes: [\r\n        \"VIDEO_GENERATION\",\r\n        \"VIDEO_GEN\",\r\n        \"CREATE_VIDEO\",\r\n        \"MAKE_VIDEO\",\r\n        \"RENDER_VIDEO\",\r\n        \"ANIMATE\",\r\n        \"CREATE_ANIMATION\",\r\n        \"VIDEO_CREATE\",\r\n        \"VIDEO_MAKE\",\r\n    ],\r\n    description: \"Generate a video based on a text prompt\",\r\n    validate: async (runtime: IAgentRuntime, _message: Memory) => {\r\n        elizaLogger.log(\"Validating video generation action\");\r\n        const lumaApiKey = runtime.getSetting(\"LUMA_API_KEY\");\r\n        elizaLogger.log(\"LUMA_API_KEY present:\", !!lumaApiKey);\r\n        return !!lumaApiKey;\r\n    },\r\n    handler: async (\r\n        runtime: IAgentRuntime,\r\n        message: Memory,\r\n        _state: State,\r\n        _options: any,\r\n        callback: HandlerCallback\r\n    ) => {\r\n        elizaLogger.log(\"Video generation request:\", message);\r\n\r\n        // Clean up the prompt by removing mentions and commands\r\n        const videoPrompt = message.content.text\r\n            .replace(/<@\\d+>/g, \"\") // Remove mentions\r\n            .replace(\r\n                /generate video|create video|make video|render video/gi,\r\n                \"\"\r\n            ) // Remove commands\r\n            .trim();\r\n\r\n        if (!videoPrompt || videoPrompt.length < 5) {\r\n            callback({\r\n                text: \"Could you please provide more details about what kind of video you'd like me to generate? For example: 'Generate a video of a sunset on a beach' or 'Create a video of a futuristic city'\",\r\n            });\r\n            return;\r\n        }\r\n\r\n        elizaLogger.log(\"Video prompt:\", videoPrompt);\r\n\r\n        callback({\r\n            text: `I'll generate a video based on your prompt: \"${videoPrompt}\". This might take a few minutes...`,\r\n        });\r\n\r\n        try {\r\n            const result = await generateVideo(videoPrompt, runtime);\r\n\r\n            if (result.success && result.data) {\r\n                // Download the video file\r\n                const response = await fetch(result.data);\r\n                const arrayBuffer = await response.arrayBuffer();\r\n                const videoFileName = `content_cache/generated_video_${Date.now()}.mp4`;\r\n\r\n                // Save video file\r\n                fs.writeFileSync(videoFileName, Buffer.from(arrayBuffer));\r\n\r\n                callback(\r\n                    {\r\n                        text: \"Here's your generated video!\",\r\n                        attachments: [\r\n                            {\r\n                                id: crypto.randomUUID(),\r\n                                url: result.data,\r\n                                title: \"Generated Video\",\r\n                                source: \"videoGeneration\",\r\n                                description: videoPrompt,\r\n                                text: videoPrompt,\r\n                            },\r\n                        ],\r\n                    },\r\n                    [videoFileName]\r\n                ); // Add the video file to the attachments\r\n            } else {\r\n                callback({\r\n                    text: `Video generation failed: ${result.error}`,\r\n                    error: true,\r\n                });\r\n            }\r\n        } catch (error) {\r\n            elizaLogger.error(`Failed to generate video. Error: ${error}`);\r\n            callback({\r\n                text: `Video generation failed: ${error.message}`,\r\n                error: true,\r\n            });\r\n        }\r\n    },\r\n    examples: [\r\n        [\r\n            {\r\n                user: \"{{user1}}\",\r\n                content: { text: \"Generate a video of a cat playing piano\" },\r\n            },\r\n            {\r\n                user: \"{{agentName}}\",\r\n                content: {\r\n                    text: \"I'll create a video of a cat playing piano for you\",\r\n                    action: \"GENERATE_VIDEO\",\r\n                },\r\n            },\r\n        ],\r\n        [\r\n            {\r\n                user: \"{{user1}}\",\r\n                content: {\r\n                    text: \"Can you make a video of a sunset at the beach?\",\r\n                },\r\n            },\r\n            {\r\n                user: \"{{agentName}}\",\r\n                content: {\r\n                    text: \"I'll generate a beautiful beach sunset video for you\",\r\n                    action: \"GENERATE_VIDEO\",\r\n                },\r\n            },\r\n        ],\r\n    ],\r\n} as Action;\r\n\r\nexport const videoGenerationPlugin: Plugin = {\r\n    name: \"videoGeneration\",\r\n    description: \"Generate videos using Luma AI\",\r\n    actions: [videoGeneration],\r\n    evaluators: [],\r\n    providers: [],\r\n};\r\n","export const LUMA_CONSTANTS = {\r\n    API_URL: \"https://api.lumalabs.ai/dream-machine/v1/generations\",\r\n    API_KEY_SETTING: \"LUMA_API_KEY\", // The setting name to fetch from runtime\r\n};\r\n"],"mappings":"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","names":[]}